# goroutine 和通道

## 进程和线程
1. 进程就是程序运行在操作系统中的一次执行过程，是系统进行资源分配和调度的基本单位。
2. 线程是进程的一个执行实例，是程序执行的最小单元，它是比进程更小的能独立运行的基本单位。
3. 一个进程可以创建和销毁多个线程，同一个进程中的多个线程可以并发执行。
4. 一个程序至少有一个进程，一个进程至少有一个线程。

## 并发和并行
1. 多线程程序在单核上运行，就是并发
2. 多线程程序在多核上运行，就是并行

## goroutine
在 Go 里，每一个并发执行的活动称为 goroutine。当一个程序启动时，只有一个 goroutine 来调用 main 函数，
称它为主 goroutine。新的 goroutine 通过 go 语句进行创建。main 函数返回时，所有的 goroutine 都暴力地直接终结。

### goroutine 的特点
1. 有独立的栈空间
2. 共享程序堆空间
3. 调度由用户控制
4. 协程是轻量级的线程

### 设置 Go 运行的 cpu 数
```go
import "runtime

num := runtime.NumCPU()
runtime.GOMAXPROCS(num)
```

## 通道
通道是可以让一个 goroutine 发送特定值到另一个 goroutine 的通信机制。每一个通道是一个具体类型的导管，叫做
通道的元素类型。一个有 int 类型元素的通道写为 `chan int`。

使用内置的 make 函数可以创建一个通道，make 可以接受第二个可选参数，一个表示通道容量的整数。
如果容量是 0，make 创建一个无缓冲通道。

```go
ch := make(chan int)     // ch 的类型是'chan int'
ch := make(chan int, 3)  // 容量为 3 的缓冲通道
```

通道有两个主要操作：发送和接收，两个操作都是用 `<-` 操作符书写。

通道支持第三个操作：关闭，它设置一个标志位来指示值当前已经发送完毕；
关闭后的发送操作将导致宕机。在一个已经关闭的通道上进行接收操作，将获取所有已经发送的值，直到通道为空；
这时任何接收操作会立即完成，同时获取到一个通道元素类型对应的零值。

```go
ch <- x   // 发送语句
x = <-ch  // 赋值语句中的接收表达式
<-ch      // 接收语句，丢弃结果

close(ch) // 关闭通道
```

### 无缓冲通道
使用无缓冲通道进行的通信导致发送和接收 goroutine 同步化。
因此，无缓冲通道也称为同步通道。当一个值在无缓冲通道上传递时，接收值后发送方 goroutine 才被再次唤醒。

### 单向通道类型
Go 的类型系统提供了单向通道类型，仅仅导出发送或接收操作。类型 `chan<- int` 是一个只能发送的通道，
类型 `<-chan int` 是一个只能接收的 int 类型通道。违反这个原则会在编译时检查出来。
